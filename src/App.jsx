import React, { useCallback, useEffect, useMemo, useRef, useState } from "react";
// Versión compacta lista para subir (con WhatsApp y logos)
const clamp2 = (n) => Math.round((Number.isFinite(n) ? n : 0) * 100) / 100;
const toFloat = (v) => { if (v===null||v===undefined) return 0; if (typeof v==="number") return isFinite(v)?v:0; const s=String(v).trim().replace(/\./g,"").replace(/,/g,"."); const n=parseFloat(s); return isNaN(n)||!isFinite(n)?0:n; };
const LS={ get:(k,d)=>{ try{ const r=localStorage.getItem(k); return r?JSON.parse(r):d; }catch{ return d;}}, set:(k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{}}};
const uid = () => Math.random().toString(36).slice(2,10);
const toLocalISO = (date) => { const d=new Date(date); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); };
const todayISO = () => toLocalISO(new Date());
const fmtARS = (n) => new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(n||0);
const fmtDM = (iso) => { const d=new Date(iso+'T00:00:00'); return String(d.getDate()).padStart(2,'0')+'/'+String(d.getMonth()+1).padStart(2,'0'); };
const WA_NUMBER='5493584118722';
const msj = ({ sexo='M', pesoKg=70, alturaCm=175, edad=35, actividad='ligera' }) => { const bmr = sexo==='F' ? (10*pesoKg)+(6.25*alturaCm)-(5*edad)-161 : (10*pesoKg)+(6.25*alturaCm)-(5*edad)+5; const f={sedentaria:1.2,ligera:1.375,moderada:1.55,intensa:1.725,muy_intensa:1.9}; return Math.round(bmr*(f[actividad]||1.375)); };
const defaultGoals={kcal:2200,p:120,c:250,f:70,fiber:30,sodium:2000,potassium:3500,iron:12,calcium:1000,vitC:90,tol:17};
const DEMO_ING=[{id:'ing-quinoa',name:'Quinoa cocida',base:100,kcal:120,p:4.4,c:21.3,f:1.9,fiber:2.8,sodium:7,potassium:172,iron:1.5,calcium:17,vitC:0},{id:'ing-tomate',name:'Tomate',base:100,kcal:18,p:0.9,c:3.9,f:0.2,fiber:1.2,sodium:5,potassium:237,iron:0.3,calcium:10,vitC:13},{id:'ing-garb',name:'Garbanzos cocidos',base:100,kcal:164,p:8.9,c:27.4,f:2.6,fiber:7.6,sodium:7,potassium:291,iron:2.9,calcium:49,vitC:1.3}];
const recipeFrom=(id,name,items,price=3500,tags=["Vegetariano","Fit"],subcats=[],photo="")=>({id,ord:1,name,photo,desc:"",portions:1,price,tags,subcats,items});
const DEMO_RECIPES=[recipeFrom('rec-quinoa','Bowl de Quinoa + Tomate',[{ingredientId:'ing-quinoa',grams:150},{ingredientId:'ing-tomate',grams:80}],4200,["Vegano","Fit"],["Internacional - Wok"]),recipeFrom('rec-garb','Guiso de Garbanzos',[{ingredientId:'ing-garb',grams:200},{ingredientId:'ing-tomate',grams:60}],4800,["Vegano"],["Proteico"])];
const DEFAULT_SUBCATS=["Bebidas","Entradas","Pastas","Proteico","Tartas","Internacional - Wok"];
const NUTRI_KEYS=[['kcal','Kcal'],['p','Prot'],['c','Carb'],['f','Grasa'],['fiber','Fibra'],['sodium','Sodio'],['potassium','Potasio'],['iron','Hierro'],['calcium','Calcio'],['vitC','Vit C'],['price','Costo']];
function sumNutri(items){const base={kcal:0,p:0,c:0,f:0,fiber:0,sodium:0,potassium:0,iron:0,calcium:0,vitC:0,price:0};for(const it of items||[]){const n=it.nutri||{};const q=it.portions||1;base.kcal+=(n.kcal||0)*q;base.p+=(n.p||0)*q;base.c+=(n.c||0)*q;base.f+=(n.f||0)*q;base.fiber+=(n.fiber||0)*q;base.sodium+=(n.sodium||0)*q;base.potassium+=(n.potassium||0)*q;base.iron+=(n.iron||0)*q;base.calcium+=(n.calcium||0)*q;base.vitC+=(n.vitC||0)*q;base.price+=(it.price||0)*q;}for(const k of Object.keys(base)) base[k]=clamp2(base[k]);return base;}
function within(goal,tol,val){const lo=goal*(1-tol/100),hi=goal*(1+tol/100);return val>=lo&&val<=hi?'ok':(val<lo?'low':'high');}
function groupWeeks(dates,anchorDow){const out=[];let cur=[];const sorted=[...dates].sort();for(let i=0;i<sorted.length;i++){const d=sorted[i];const dow=new Date(d+'T00:00:00').getDay();if(cur.length>0&&dow===anchorDow){out.push(cur);cur=[];}cur.push(d);}if(cur.length)out.push(cur);return out;}
export default function App(){
  const [user,setUser]=useState(()=>LS.get('ds_user',null));
  const [goals,setGoals]=useState(()=>LS.get('ds_goals',defaultGoals));
  const [ingredients,setIngredients]=useState(()=>LS.get('ds_ingredients',DEMO_ING));
  const [recipes,setRecipes]=useState(()=>LS.get('ds_recipes',DEMO_RECIPES));
  const [settings,setSettings]=useState(()=>LS.get('ds_settings',{subcats:DEFAULT_SUBCATS}));
  const [plan,setPlan]=useState(()=>LS.get('ds_plan',{[todayISO()]:[]}));
  const [activeDate,setActiveDate]=useState(()=>Object.keys(LS.get('ds_plan',{[todayISO()]:[]}))[0]||todayISO());
  const [filters,setFilters]=useState({search:"",tags:{Vegano:false,Vegetariano:false,Fit:false},subcats:{}});
  const [quickAddFor,setQuickAddFor]=useState(null);
  const [collapsedByDate,setCollapsedByDate]=useState({});
  const [loginOpen,setLoginOpen]=useState(false);
  const [showWeek,setShowWeek]=useState(()=>LS.get('ds_show_week',false));
  const [showMonth,setShowMonth]=useState(()=>LS.get('ds_show_month',false));
  useEffect(()=>LS.set('ds_goals',goals),[goals]);useEffect(()=>LS.set('ds_ingredients',ingredients),[ingredients]);useEffect(()=>LS.set('ds_recipes',recipes),[recipes]);useEffect(()=>LS.set('ds_plan',plan),[plan]);useEffect(()=>LS.set('ds_user',user),[user]);useEffect(()=>LS.set('ds_settings',settings),[settings]);useEffect(()=>LS.set('ds_show_week',showWeek),[showWeek]);useEffect(()=>LS.set('ds_show_month',showMonth),[showMonth]);
  const ingById=useMemo(()=>Object.fromEntries(ingredients.map(i=>[i.id,i])),[ingredients]);
  function calcRecipeNutri(r){const n={kcal:0,p:0,c:0,f:0,fiber:0,sodium:0,potassium:0,iron:0,calcium:0,vitC:0};for(const it of (r.items||[])){const ing=ingById[it.ingredientId];if(!ing)continue;const factor=(it.grams||0)/(ing.base||100);n.kcal+=(ing.kcal||0)*factor;n.p+=(ing.p||0)*factor;n.c+=(ing.c||0)*factor;n.f+=(ing.f||0)*factor;n.fiber+=(ing.fiber||0)*factor;n.sodium+=(ing.sodium||0)*factor;n.potassium+=(ing.potassium||0)*factor;n.iron+=(ing.iron||0)*factor;n.calcium+=(ing.calcium||0)*factor;n.vitC+=(ing.vitC||0)*factor;}for(const k of Object.keys(n)) n[k]=clamp2(n[k]);return n;}
  const richRecipes=useMemo(()=>recipes.map(r=>({...r,nutri:calcRecipeNutri(r)})),[recipes,ingById]);
  const suggestions=useMemo(()=>{const keys=['kcal','p','c','f'];const limit=(k)=>(goals[k]||0)*(1+(goals.tol||0)/100);const score=(r)=>keys.reduce((a,k)=>a+(goals[k]?Math.abs((r.nutri[k]||0)-goals[k])/(goals[k]||1):0),0);return richRecipes.filter(r=>keys.every(k=>!goals[k]||(r.nutri[k]||0)<=limit(k))).sort((a,b)=>score(a)-score(b)).slice(0,9);},[richRecipes,goals]);
  const filteredMenu=useMemo(()=>{const t=filters.tags;const s=filters.subcats;const activeTags=Object.entries(t).filter(([,v])=>v).map(([k])=>k);const activeSubs=Object.entries(s).filter(([,v])=>v).map(([k])=>k);return richRecipes.filter(r=>!filters.search||r.name.toLowerCase().includes(filters.search.toLowerCase())).filter(r=>activeTags.length===0||(r.tags||[]).some(tag=>activeTags.includes(tag))).filter(r=>activeSubs.length===0||activeSubs.every(sc=>(r.subcats||[]).includes(sc))).sort((a,b)=>(a.ord||0)-(b.ord||0));},[richRecipes,filters]);
  const dayItems=plan[activeDate]||[]; const dayTotals=useMemo(()=>sumNutri(dayItems),[dayItems]);
  const addToDate=useCallback((dateISO,recipeId,portions=1)=>{const rec=richRecipes.find(r=>r.id===recipeId);if(!rec)return;const it={id:uid(),recipeId,name:rec.name,portions,price:rec.price||0,nutri:rec.nutri};setPlan(prev=>({...prev,[dateISO]:[...(prev[dateISO]||[]),it]}));},[richRecipes]);
  const removeItem=useCallback((dateISO,itemId)=>{setPlan(prev=>({...prev,[dateISO]:(prev[dateISO]||[]).filter(x=>x.id!==itemId)}));},[]);
  const changeQty=useCallback((dateISO,itemId,delta)=>{setPlan(prev=>({...prev,[dateISO]:(prev[dateISO]||[]).map(x=>x.id===itemId?{...x,portions:Math.max(0,(x.portions||1)+delta)}:x)}));},[]);
  function waTextForDates(dateList){const dates=(dateList||[]).filter(Boolean);const lines=["Pedido Dalai Strong",""];let grand={price:0,kcal:0,p:0,c:0,f:0};for(const d of dates){const items=plan[d]||[];if(!items.length)continue;const tot=sumNutri(items);grand.price+=tot.price;grand.kcal+=tot.kcal;grand.p+=tot.p;grand.c+=tot.c;grand.f+=tot.f;lines.push(`[${d}]`);for(const it of items){const sub=fmtARS((it.price||0)*(it.portions||1));lines.push(`• ${it.name} · x${it.portions} · ${sub}`);}lines.push(`Subtotal: ${fmtARS(tot.price)} | Kcal ${tot.kcal} · Prot ${tot.p} · Carb ${tot.c} · Grasa ${tot.f}`);lines.push("");}lines.push(`TOTAL aprox: ${fmtARS(grand.price)} | Kcal ${clamp2(grand.kcal)} · Prot ${clamp2(grand.p)} · Carb ${clamp2(grand.c)} · Grasa ${clamp2(grand.f)}`);lines.push(`Nombre: ${settings.customerName||''}`);lines.push(`Dirección: ${settings.customerAddress||''}`);lines.push(`Forma de pago: `);return lines.join("\\n");}
  const waLinkForDates=(dateList)=>`https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(waTextForDates(dateList))}`;
  const waLinkForDay=(dateISO)=>waLinkForDates([dateISO]);
  function downloadDayPDF(dateISO){const items=plan[dateISO]||[];const tot=sumNutri(items);const html=`<!doctype html><html><head><meta charset="utf-8"><title>Pedido ${dateISO}</title><style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;margin:24px} h1{margin:0 0 8px} table{width:100%;border-collapse:collapse;margin-top:12px} th,td{border:1px solid #ddd;padding:8px;text-align:left} .tot{margin-top:12px;font-weight:600}</style></head><body><div style="display:flex;gap:12px;align-items:center"><img src="/logo.svg" width="64" height="64"/><h1>Dalai Strong — Pedido ${dateISO}</h1></div><table><thead><tr><th>Plato</th><th>Porciones</th><th>Precio</th></tr></thead><tbody>${items.map(it=>`<tr><td>${it.name}</td><td>${it.portions}</td><td>${fmtARS(it.price*it.portions)}</td></tr>`).join("")}</tbody></table><div class="tot">Total: ${fmtARS(tot.price)} — Kcal ${tot.kcal} · Prot ${tot.p} · Carb ${tot.c} · Grasa ${tot.f}</div><p>Retiro/Envío: <a href="https://maps.google.com/?q=-33.1341388889,-64.3640555556">Ubicación</a></p><p style="margin-top:24px;font-size:12px;color:#333">Datos SARA2 – ENNyS 2 (valores orientativos; pueden variar según preparación).</p><script>window.onload=()=>window.print()</script></body></html>`;const w=window.open("","_blank");if(!w)return;w.document.open();w.document.write(html);w.document.close();}
  const weekDates = useMemo(()=>{const base=new Date(activeDate+'T00:00:00');const out=[];for(let i=0;i<7;i++){const d=new Date(base);d.setDate(d.getDate()+i);out.push(toLocalISO(d));}return out;},[activeDate]);
  const monthDates = useMemo(()=>{const d=new Date(activeDate||todayISO());const y=d.getFullYear(),m=d.getMonth();const first=new Date(y,m,1);const nextM=new Date(y,m+1,1);const out=[];for(let dt=new Date(first);dt<nextM;dt.setDate(dt.getDate()+1)){out.push(toLocalISO(dt));}return out;},[activeDate]);
  return (<div className="min-h-screen bg-white text-stone-900">
    <Header user={user} onLogin={()=>setLoginOpen(true)} onLogout={()=>{setUser(null);}}/>
    <Hero/>
    <Section id="goals" title="Objetivos Nutricionales">
      <GoalsEditor goals={goals} setGoals={setGoals}/>
    </Section>
    <Section id="suggestions" title="Sugerencias por Objetivos">
      <SuggestionsGrid list={suggestions} onAdd={(id)=>addToDate(activeDate,id,1)}/>
    </Section>
    <Section id="menu" title="Menú">
      <MenuFilters filters={filters} setFilters={setFilters} subcats={settings.subcats||[]}/>
      <MenuGrid menu={filteredMenu} onAdd={(id)=>addToDate(activeDate,id,1)}/>
    </Section>
    <Section id="day" title="Tu Día – Pedido" extra={<div className='flex items-center gap-2'><a href={waLinkForDay(activeDate)} target='_blank' rel='noreferrer' className='inline-flex items-center gap-1 px-3 py-1.5 rounded-xl bg-[#25D366] text-white text-sm'>WhatsApp</a></div>}>
      <DayView goals={goals} dateISO={activeDate} setDateISO={setActiveDate} items={dayItems} totals={dayTotals}
        onQty={(id,d)=>changeQty(activeDate,id,d)} onRemove={(id)=>removeItem(activeDate,id)} onWA={()=>window.open(waLinkForDay(activeDate),'_blank')} onPDF={()=>downloadDayPDF(activeDate)}/>
    </Section>
    <Section id="week" title="Plan Semanal" extra={<div className='flex items-center gap-2'><button onClick={()=>setShowWeek(v=>!v)} className='px-3 py-1.5 rounded-xl text-sm border'>{showWeek?'Ocultar':'Mostrar'}</button><a href={waLinkForDates(weekDates)} target='_blank' rel='noreferrer' className='inline-flex items-center gap-1 px-3 py-1.5 rounded-xl bg-[#25D366] text-white text-sm'>WhatsApp</a></div>}>
      {!showWeek ? (<p className='text-sm text-stone-500'>Sección oculta. Usá “Mostrar” para planificar por semana.</p>) : (<PlannerWeek plan={plan} setPlan={setPlan} dates={weekDates} collapsedByDate={collapsedByDate} toggleCollapse={(d)=>setCollapsedByDate(s=>({...s,[d]:!s[d]}))} onQuickAdd={setQuickAddFor}/>)}
    </Section>
    <Section id="month" title="Plan Mensual" extra={<div className='flex items-center gap-2'><button onClick={()=>setShowMonth(v=>!v)} className='px-3 py-1.5 rounded-xl text-sm border'>{showMonth?'Ocultar':'Mostrar'}</button><a href={waLinkForDates(monthDates)} target='_blank' rel='noreferrer' className='inline-flex items-center gap-1 px-3 py-1.5 rounded-xl bg-[#25D366] text-white text-sm'>WhatsApp</a></div>}>
      {!showMonth ? (<p className='text-sm text-stone-500'>Sección oculta. Activala si querés armar tu mes en 4 semanas.</p>) : (<PlannerMonth plan={plan} setPlan={setPlan} dates={monthDates} anchorDow={new Date(activeDate + 'T00:00:00').getDay()} collapsedByDate={collapsedByDate} toggleCollapse={(d)=>setCollapsedByDate(s=>({...s,[d]:!s[d]}))} onQuickAdd={setQuickAddFor}/>)}
    </Section>
    <Section id="notice" title="Aviso Nutricional y Alérgenos"><p className="text-sm text-stone-700">Datos SARA 2 (ENNyS 2). Valores orientativos.</p></Section>
    <Section id="privacy" title="Privacidad y Cookies"><PrivacyBlock/></Section>
    <Section id="admin" title="Admin" extra={!user&&(<span className="text-xs ml-2">(solo admin)</span>)}>{!user?(<div className='flex flex-col gap-2'><p className='text-sm'>Iniciá sesión para acceder al panel.</p><button onClick={()=>setLoginOpen(true)} className='px-4 py-2 rounded-2xl bg-emerald-700 text-white'>Login demo</button></div>):(<AdminPanel ingredients={ingredients} setIngredients={setIngredients} recipes={recipes} setRecipes={setRecipes} settings={settings} setSettings={setSettings}/>)}</Section>
    <Footer/>
    <a href={waLinkForDay(activeDate)} target="_blank" rel="noreferrer" aria-label="Enviar por WhatsApp" className="fixed bottom-5 right-4 p-3 rounded-full shadow-lg bg-[#25D366] hover:brightness-95">WA</a>
    {quickAddFor&&(<QuickAddModal dateISO={quickAddFor} onClose={()=>setQuickAddFor(null)} recipes={richRecipes} onPick={(rid)=>{addToDate(quickAddFor,rid,1);setQuickAddFor(null);}}/>)}
    {loginOpen&&(<LoginModal onClose={()=>setLoginOpen(false)} onSubmit={(u,p)=>{ if((u||'').toLowerCase()==='dalai'&&(p||'').toLowerCase()==='strong'){ setUser({email:'demo@dalia.strong',name:'Dalai Demo',role:'admin'}); setLoginOpen(false); return true;} return false; }}/>)}
  </div>);}
function Header({user,onLogin,onLogout}){const nav=[{id:'hero',label:'Inicio'},{id:'goals',label:'Objetivos'},{id:'suggestions',label:'Sugerencias'},{id:'menu',label:'Menú'},{id:'day',label:'Tu Día'},{id:'week',label:'Semanal'},{id:'month',label:'Mensual'},{id:'admin',label:'Admin'}];return(<header className="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-stone-200"><div className="max-w-5xl mx-auto px-3 py-2 flex items-center justify-between"><div className="flex items-center gap-2"><img src="/logo.svg" alt="Dalai Strong" className="w-8 h-8 rounded" onError={(e)=>{e.currentTarget.style.display='none';}}/><span className="font-semibold text-emerald-800">Dalai Strong</span></div><nav className="hidden md:flex gap-3">{nav.map(n=>(<a key={n.id} href={`#${n.id}`} className="text-sm text-stone-700 hover:text-emerald-800">{n.label}</a>))}</nav><div className="flex items-center gap-2">{user?(<><span className="text-sm text-stone-700">{user.name||user.email}</span><button onClick={onLogout} className="px-3 py-1.5 rounded-xl bg-stone-200 hover:bg-stone-300 text-sm">Salir</button></>):(<button onClick={onLogin} className="px-3 py-1.5 rounded-xl bg-emerald-700 text-white text-sm">Login</button>)}</div></div></header>);}
function Hero(){return(<section id="hero" className="bg-gradient-to-b from-emerald-100 to-white border-b border-stone-200"><div className="max-w-5xl mx-auto px-3 py-8 flex flex-col md:flex-row items-center gap-6"><div className="flex-1"><h1 className="text-2xl md:text-3xl font-bold text-emerald-800">Comé rico, equilibrado y sin complicarte</h1><p className="text-stone-700 mt-2">Planner nutricional diario, semanal y mensual con platos Vegano, Vegetariano y Fit. Pedí por WhatsApp y descargá tu PDF.</p><div className="mt-4 flex gap-2"><a href="#menu" className="px-4 py-2 rounded-2xl bg-emerald-700 text-white">Ir al Menú</a><a href="#day" className="px-4 py-2 rounded-2xl bg-stone-800 text-white">Ver Pedido</a></div></div><div className="flex-1 w-full h-36 md:h-48 rounded-2xl bg-[url('/logo.svg')] bg-contain bg-no-repeat bg-center border border-emerald-200"/></div></section>);}
function Section({id,title,children,extra}){return(<section id={id} className="max-w-5xl mx-auto px-3 py-6"><div className="flex items-baseline justify-between"><h2 className="text-lg md:text-xl font-semibold text-emerald-800">{title}</h2>{extra}</div><div className="mt-3">{children}</div></section>);}
function GoalsEditor({goals,setGoals}){const [sexo,setSexo]=useState('M');const [peso,setPeso]=useState(80);const [altura,setAltura]=useState(178);const [edad,setEdad]=useState(38);const [act,setAct]=useState('ligera');function applyMSJ(){const kcal=msj({sexo,pesoKg:toFloat(peso),alturaCm:toFloat(altura),edad:toFloat(edad),actividad:act});setGoals({...goals,kcal});}function setField(k,v){setGoals({...goals,[k]:toFloat(v)});}function step(k,d){setGoals(g=>({...g,[k]:clamp2((g[k]||0)+d)}));}const fields=[['kcal','Calorías (kcal)'],['p','Proteína (g)'],['c','Carbohidratos (g)'],['f','Grasa (g)'],['fiber','Fibra (g)'],['sodium','Sodio (mg)'],['potassium','Potasio (mg)'],['iron','Hierro (mg)'],['calcium','Calcio (mg)'],['vitC','Vit C (mg)']];return(<div className="grid md:grid-cols-3 gap-4"><div className="md:col-span-2 border rounded-2xl p-4"><div className="grid grid-cols-1 md:grid-cols-2 gap-2">{fields.map(([k,label])=>(<div key={k} className="flex items-center gap-2"><label className="w-32 text-sm text-stone-700">{label}</label><div className="flex items-center gap-2"><button className="px-2 py-1 rounded-lg bg-stone-200" onClick={()=>step(k,-1)}>−</button><input className="w-24 border rounded-lg px-2 py-1" value={goals[k]} onChange={e=>setField(k,e.target.value)} aria-label={label}/><button className="px-2 py-1 rounded-lg bg-stone-200" onClick={()=>step(k,+1)}>+</button></div></div>))}</div><div className="mt-2 flex items-center gap-3"><label className="text-sm">Tolerancia ±%</label><input type="range" min={5} max={30} value={goals.tol} onChange={e=>setGoals({...goals,tol:toFloat(e.target.value)})}/><span className="text-sm w-10">{goals.tol}%</span></div><div className="mt-3 grid grid-cols-2 gap-2 text-sm"><label>Sexo</label><select className="border rounded px-2 py-1" value={sexo} onChange={e=>setSexo(e.target.value)}><option value="M">Masculino</option><option value="F">Femenino</option></select><label>Peso (kg)</label><input className="border rounded px-2 py-1" value={peso} onChange={e=>setPeso(e.target.value)}/><label>Altura (cm)</label><input className="border rounded px-2 py-1" value={altura} onChange={e=>setAltura(e.target.value)}/><label>Edad</label><input className="border rounded px-2 py-1" value={edad} onChange={e=>setEdad(e.target.value)}/><label>Actividad</label><select className="border rounded px-2 py-1" value={act} onChange={e=>setAct(e.target.value)}><option value="sedentaria">Sedentaria</option><option value="ligera">Ligera</option><option value="moderada">Moderada</option><option value="intensa">Intensa</option><option value="muy_intensa">Muy intensa</option></select></div><button onClick={applyMSJ} className="mt-3 w-full px-3 py-2 rounded-xl bg-emerald-700 text-white">Aplicar Objetivos Peso‑Sexo‑Edad‑Altura‑Actividad</button></div><div className="border rounded-2xl p-4"><h3 className="font-medium mb-2">Guía rápida</h3><p className="text-sm text-stone-600">Ajustá Kcal/Prot/Carb/Grasa y el % de tolerancia. Las <b>Sugerencias</b> no superan el objetivo + tolerancia y se ordenan por cercanía a tus metas.</p></div></div>);}
function SuggestionsGrid({list,onAdd}){if(!list.length) return <p className="text-sm text-stone-500">No hay sugerencias con los objetivos actuales.</p>;return(<div className="grid sm:grid-cols-2 md:grid-cols-3 gap-4">{list.map(r=>(<div key={r.id} className="border rounded-2xl p-3"><div className="font-medium">{r.name}</div><div className="text-xs text-stone-600 mt-1">Kcal {r.nutri.kcal} · Prot {r.nutri.p} · Carb {r.nutri.c} · Grasa {r.nutri.f} · Fibr {r.nutri.fiber}</div><div className="mt-2 flex items-center gap-2"><button onClick={()=>onAdd(r.id)} className="px-3 py-1.5 rounded-xl bg-emerald-700 text-white">Agregar</button><div className="flex gap-1 text-xs text-stone-700">{(r.tags||[]).map(t=><span key={t} className="px-2 py-0.5 rounded-full bg-stone-200">{t}</span>)}</div></div></div>))}</div>);}
function MenuFilters({filters,setFilters,subcats}){const tags=["Vegano","Vegetariano","Fit"];const subs=subcats||[];return(<div className="flex flex-col gap-3"><div className="flex flex-col md:flex-row md:items-center gap-3"><input placeholder="Buscar plato…" className="flex-1 border rounded-xl px-3 py-2" value={filters.search} onChange={e=>setFilters({...filters,search:e.target.value})}/><div className="flex flex-wrap gap-2">{tags.map(t=>(<button key={t} onClick={()=>setFilters(f=>({...f,tags:{...f.tags,[t]:!f.tags[t]}}))} className={`px-3 py-1.5 rounded-2xl border ${filters.tags[t]?'bg-emerald-700 text-white border-emerald-700':'bg-white text-stone-700 border-stone-300'}`}>{t}</button>))}</div></div><div className="flex flex-wrap gap-2">{subs.map(s=>(<button key={s} onClick={()=>setFilters(f=>({...f,subcats:{...(f.subcats||{}),[s]:!(f.subcats?.[s])}}))} className={`px-3 py-1.5 rounded-2xl border ${filters.subcats?.[s]?'bg-stone-900 text-white border-stone-900':'bg-white text-stone-700 border-stone-300'}`}>{s}</button>))}</div></div>);}
function MenuGrid({menu,onAdd}){return(<div className="grid sm:grid-cols-2 md:grid-cols-3 gap-4 mt-3">{menu.map(r=>(<div key={r.id} className="border rounded-2xl p-3 shadow-sm"><div className="h-28 bg-stone-100 rounded-lg mb-2 bg-center bg-cover" style={{backgroundImage:r.photo?`url(${r.photo})`:'none'}} /><div className="font-medium text-stone-900">{r.name}</div><div className="text-sm text-stone-600">{fmtARS(r.price||0)}</div><div className="text-xs text-stone-600 mt-1">Prot {r.nutri.p} · Carb {r.nutri.c} · Grasa {r.nutri.f} · Fibr {r.nutri.fiber}</div><div className="mt-2 flex gap-2 items-center"><button onClick={()=>onAdd(r.id)} className="px-3 py-1.5 rounded-xl bg-emerald-700 text-white">Agregar</button><div className="flex gap-1 text-xs text-stone-700">{(r.tags||[]).map(t=><span key={t} className="px-2 py-0.5 rounded-full bg-stone-200">{t}</span>)}</div></div></div>))}</div>);}
function DayView({dateISO,setDateISO,items,totals,onQty,onRemove,onWA,onPDF,goals}){return(<div><div className="flex flex-wrap items-center gap-2"><input type="date" className="border rounded-xl px-3 py-2" value={dateISO} onChange={e=>setDateISO(e.target.value)}/><a href="#menu" className="px-3 py-2 rounded-xl bg-stone-200">Agregar del Menú</a><a href="#" onClick={(e)=>{e.preventDefault();onWA();}} className="px-3 py-2 rounded-xl bg-[#25D366] text-white">Enviar</a><button onClick={onPDF} className="px-3 py-2 rounded-xl bg-stone-800 text-white">PDF</button></div><div className="mt-3 border rounded-2xl overflow-hidden"><table className="w-full text-sm"><thead className="bg-stone-100"><tr><th className="text-left p-2">Plato</th><th className="text-left p-2">Porciones</th><th className="text-left p-2">Acciones</th><th className="text-left p-2">Subtotal</th></tr></thead><tbody>{items.length===0?(<tr><td colSpan={4} className="p-3 text-stone-500">Sin platos aún. Agregá desde el menú.</td></tr>):items.map(it=>(<tr key={it.id} className="border-t"><td className="p-2">{it.name}</td><td className="p-2">x{it.portions}</td><td className="p-2 flex gap-2"><button onClick={()=>onQty(it.id,-1)} className="px-2 py-1 rounded-lg bg-stone-200">−</button><button onClick={()=>onQty(it.id,+1)} className="px-2 py-1 rounded-lg bg-stone-200">+</button><button onClick={()=>onRemove(it.id)} className="px-2 py-1 rounded-lg bg-rose-600 text-white">Quitar</button></td><td className="p-2">{fmtARS((it.price||0)*(it.portions||1))}</td></tr>))}</tbody></table></div><div className="mt-3 grid md:grid-cols-2 gap-4"><TotalsCard title="Totales del día" totals={totals}/><Bars goals={goals} totals={totals}/></div></div>);}
function TotalsCard({title,totals}){const rows=[['Calorías',`${totals.kcal} kcal`],['Proteína',`${totals.p} g`],['Carbohidratos',`${totals.c} g`],['Grasa',`${totals.f} g`],['Fibra',`${totals.fiber} g`],['Sodio',`${totals.sodium} mg`],['Potasio',`${totals.potassium} mg`],['Hierro',`${totals.iron} mg`],['Calcio',`${totals.calcium} mg`],['Vit C',`${totals.vitC} mg`],['Costo',fmtARS(totals.price)]];return(<div className="border rounded-2xl p-4"><h3 className="font-medium">{title}</h3><div className="grid grid-cols-2 gap-x-4 gap-y-1 mt-2 text-sm">{rows.map(([k,v])=>(<React.Fragment key={k}><div className="text-stone-600">{k}</div><div className="font-medium">{v}</div></React.Fragment>))}</div></div>);}
function Bars({goals,totals}){const keys=[['kcal','Kcal'],['p','Prot'],['c','Carb'],['f','Grasa']];return(<div className="border rounded-2xl p-4"><h3 className="font-medium">Barras de progreso</h3><div className="mt-2 flex flex-col gap-2">{keys.map(([k,lab])=>{const perc=goals[k]?Math.min(100,Math.round((totals[k]/goals[k])*100)):0;const state=within(goals[k]||0,goals.tol||0,totals[k]||0);const color=state==='ok'?'bg-emerald-600':(state==='low'?'bg-stone-400':'bg-rose-600');return(<div key={k}><div className="text-xs text-stone-600 mb-1">{lab} ({totals[k]} / {goals[k]})</div><div className="w-full h-3 bg-stone-200 rounded-full overflow-hidden"><div className={`h-3 ${color}`} style={{width:perc+"%"}}/></div></div>);})}</div></div>);}
function WeekSummaryTable({dates,plan}){const rows=dates.map(d=>({date:d,totals:sumNutri(plan[d]||[])}));const tAll=sumNutri(dates.flatMap(d=>plan[d]||[]));return(<div className="overflow-auto border rounded-2xl mt-2"><table className="w-full text-sm"><thead className="bg-stone-100"><tr><th className="p-2 text-left">Fecha</th>{NUTRI_KEYS.map(([k,label])=>(<th key={k} className="p-2 text-left">{label}</th>))}</tr></thead><tbody>{rows.map(r=>(<tr key={r.date} className="border-t"><td className="p-2 whitespace-nowrap">{fmtDM(r.date)}</td>{NUTRI_KEYS.map(([k])=>(<td key={k} className="p-2">{k==='price'?fmtARS(r.totals[k]):r.totals[k]}</td>))}</tr>))}<tr className="bg-stone-50 font-medium border-t"><td className="p-2">TOTAL</td>{NUTRI_KEYS.map(([k])=>(<td key={k} className="p-2">{k==='price'?fmtARS(tAll[k]):tAll[k]}</td>))}</tr></tbody></table></div>);}
function PlannerWeek({plan,setPlan,dates,collapsedByDate,toggleCollapse,onQuickAdd}){return(<div className="border rounded-2xl p-3"><WeekSummaryTable dates={dates} plan={plan}/></div>);}
function PlannerMonth({plan,setPlan,dates,anchorDow,collapsedByDate,toggleCollapse,onQuickAdd}){const weeks=groupWeeks(dates,anchorDow);return(<div className="flex flex-col gap-4">{weeks.map((wdays,idx)=>{const label=`Semana ${idx+1} (${fmtDM(wdays[0])} – ${fmtDM(wdays[wdays.length-1])})`;return(<div key={idx} className="border rounded-2xl p-3"><div className="font-medium mb-1">{label}</div><WeekSummaryTable dates={wdays} plan={plan}/></div>);})}</div>);}
function PrivacyBlock(){const [accepted,setAccepted]=useState(()=>LS.get('ds_privacy_accepted',false));useEffect(()=>LS.set('ds_privacy_accepted',accepted),[accepted]);if(accepted)return <p className="text-sm text-stone-700">Gracias por aceptar la política de privacidad y cookies.</p>;return(<div className="p-4 border rounded-2xl bg-stone-50"><p className="text-sm">Usamos almacenamiento local para guardar tus objetivos, plan y login. Sin rastreadores de terceros.</p><button onClick={()=>setAccepted(true)} className="mt-2 px-3 py-2 rounded-xl bg-emerald-700 text-white">Aceptar</button></div>);}
function AdminPanel({ingredients,setIngredients,recipes,setRecipes,settings,setSettings}){return(<div className="border rounded-2xl p-3">Panel admin demo.</div>);}
function QuickAddModal(){return null;}
function LoginModal(){return null;}
function Footer(){return(<footer className="mt-8 border-t"><div className="max-w-5xl mx-auto px-3 py-6 text-sm flex flex-col md:flex-row gap-2 md:items-center md:justify-between"><div className="text-stone-600">© {new Date().getFullYear()} Dalai Strong — Río Cuarto</div><div className="text-stone-600">App desarrollada por <a href="https://www.linkedin.com/in/walter-valdivieso/" target="_blank" rel="noreferrer" className="underline hover:text-emerald-800">Walter Valdivieso</a></div></div></footer>);}
